# ============================================================================
# NGINX INGRESS CONTROLLER
# ============================================================================
#
# ⚠️  NON-STANDARD KUBERNETES RESOURCE (ADDON/INFRASTRUCTURE)
#
# This file is DIFFERENT from the other Kubernetes resources (deployment.yaml,
# service.yaml, ingress.yaml, hpa.yaml) because:
#
# 1. ADDON vs CORE RESOURCE:
#    - Core K8s resources (Deployment, Service, Ingress, HPA) are built into
#      Kubernetes - you create them with kubectl apply
#    - Ingress Controller is an ADDON - software you install separately that
#      actually implements the Ingress routing logic
#
# 2. WHY IS IT NEEDED?
#    - Kubernetes Ingress resources (like ingress.yaml) are just RULES
#    - They describe "route traffic from / to service X on port 80"
#    - But Ingress resources don't DO anything by themselves
#    - You need an Ingress Controller to READ those rules and route traffic
#
# 3. THE RELATIONSHIP:
#    - Ingress Controller (this file) = The traffic router software (NGINX)
#    - ingress.yaml = Configuration file telling the controller where to route
#
#    Analogy:
#    - Ingress Controller = Web server (like NGINX or Apache)
#    - ingress.yaml = The config file (/etc/nginx/nginx.conf)
#
# 4. WHY MULTIPLE OPTIONS?
#    Kubernetes doesn't mandate one ingress controller. You choose:
#    - NGINX Ingress Controller (this file) - most popular
#    - Traefik - feature-rich, built-in Let's Encrypt
#    - AWS ALB Ingress Controller - integrates with AWS Application Load Balancer
#    - HAProxy, Istio, Envoy, etc.
#
#    Your ingress.yaml specifies which one to use:
#      spec:
#        ingressClassName: nginx  # ← Uses NGINX controller
#
# 5. PRODUCTION DEPLOYMENT:
#    In production, you'd typically install this via Helm:
#      helm install nginx-ingress ingress-nginx/ingress-nginx \
#        --set controller.service.type=LoadBalancer \
#        --set controller.autoscaling.enabled=true
#
#    This file is the raw YAML equivalent for learning/local development.
#
# 6. WHAT THIS FILE CONTAINS:
#    - Namespace: Isolated namespace for ingress controller
#    - ServiceAccounts: Identity for the controller pods
#    - Roles/ClusterRoles: Permissions to read Ingress resources
#    - RoleBindings: Link roles to service accounts
#    - ConfigMap: NGINX configuration (allow-snippet-annotations, etc.)
#    - Services: Expose NGINX on ports 80/443
#    - Deployment: The actual NGINX controller pods
#    - Jobs: Webhook certificate generation (validates Ingress resources)
#    - IngressClass: Defines the "nginx" class that ingress.yaml references
#    - ValidatingWebhookConfiguration: Validates Ingress YAML before creation
#
# ============================================================================

apiVersion: v1  # Kubernetes API version for Namespaces
kind: Namespace  # Create isolated namespace for ingress controller
metadata:
  labels:
    app.kubernetes.io/instance: ingress-nginx  # Instance identifier
    app.kubernetes.io/name: ingress-nginx  # Application name
  name: ingress-nginx  # Namespace name (all controller resources go here)
---
# ============================================================================
# SERVICE ACCOUNTS - Identity for pods to authenticate with Kubernetes API
# ============================================================================
apiVersion: v1
automountServiceAccountToken: true  # Automatically mount API token in pods
kind: ServiceAccount  # Identity used by controller pods
metadata:
  labels:
    app.kubernetes.io/component: controller  # This is for the main controller
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
    app.kubernetes.io/version: 1.8.1
  name: ingress-nginx  # ServiceAccount name (used in Deployment spec)
  namespace: ingress-nginx
---
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    app.kubernetes.io/component: admission-webhook
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
    app.kubernetes.io/version: 1.8.1
  name: ingress-nginx-admission
  namespace: ingress-nginx
---
# ============================================================================
# RBAC - Permissions for the ingress controller to function
# ============================================================================
# Role: Permissions within the ingress-nginx namespace only
# ClusterRole: Cluster-wide permissions (read Ingress resources across all namespaces)
# RoleBinding/ClusterRoleBinding: Link ServiceAccounts to Roles
#
# Why needed: Controller needs to:
# - Read Ingress resources to know routing rules
# - Read Services/Endpoints to know where to route traffic
# - Read Secrets for TLS certificates
# - Update Ingress status fields
# - Create/update ConfigMaps for dynamic configuration
# ============================================================================
apiVersion: rbac.authorization.k8s.io/v1
kind: Role  # Namespace-scoped permissions (within ingress-nginx namespace)
metadata:
  labels:
    app.kubernetes.io/component: controller
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
    app.kubernetes.io/version: 1.8.1
  name: ingress-nginx
  namespace: ingress-nginx
rules:  # List of permissions
- apiGroups:
  - ""
  resources:
  - namespaces
  verbs:
  - get
- apiGroups:
  - ""
  resources:
  - configmaps
  - pods
  - secrets
  - endpoints
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - ""
  resources:
  - services
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - networking.k8s.io
  resources:
  - ingresses
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - networking.k8s.io
  resources:
  - ingresses/status
  verbs:
  - update
- apiGroups:
  - networking.k8s.io
  resources:
  - ingressclasses
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - coordination.k8s.io
  resourceNames:
  - ingress-nginx-leader
  resources:
  - leases
  verbs:
  - get
  - update
- apiGroups:
  - coordination.k8s.io
  resources:
  - leases
  verbs:
  - create
- apiGroups:
  - ""
  resources:
  - events
  verbs:
  - create
  - patch
- apiGroups:
  - discovery.k8s.io
  resources:
  - endpointslices
  verbs:
  - list
  - watch
  - get
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  labels:
    app.kubernetes.io/component: admission-webhook
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
    app.kubernetes.io/version: 1.8.1
  name: ingress-nginx-admission
  namespace: ingress-nginx
rules:
- apiGroups:
  - ""
  resources:
  - secrets
  verbs:
  - get
  - create
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
    app.kubernetes.io/version: 1.8.1
  name: ingress-nginx
rules:
- apiGroups:
  - ""
  resources:
  - configmaps
  - endpoints
  - nodes
  - pods
  - secrets
  - namespaces
  verbs:
  - list
  - watch
- apiGroups:
  - coordination.k8s.io
  resources:
  - leases
  verbs:
  - list
  - watch
- apiGroups:
  - ""
  resources:
  - nodes
  verbs:
  - get
- apiGroups:
  - ""
  resources:
  - services
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - networking.k8s.io
  resources:
  - ingresses
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - ""
  resources:
  - events
  verbs:
  - create
  - patch
- apiGroups:
  - networking.k8s.io
  resources:
  - ingresses/status
  verbs:
  - update
- apiGroups:
  - networking.k8s.io
  resources:
  - ingressclasses
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - discovery.k8s.io
  resources:
  - endpointslices
  verbs:
  - list
  - watch
  - get
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    app.kubernetes.io/component: admission-webhook
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
    app.kubernetes.io/version: 1.8.1
  name: ingress-nginx-admission
rules:
- apiGroups:
  - admissionregistration.k8s.io
  resources:
  - validatingwebhookconfigurations
  verbs:
  - get
  - update
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  labels:
    app.kubernetes.io/component: controller
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
    app.kubernetes.io/version: 1.8.1
  name: ingress-nginx
  namespace: ingress-nginx
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: ingress-nginx
subjects:
- kind: ServiceAccount
  name: ingress-nginx
  namespace: ingress-nginx
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  labels:
    app.kubernetes.io/component: admission-webhook
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
    app.kubernetes.io/version: 1.8.1
  name: ingress-nginx-admission
  namespace: ingress-nginx
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: ingress-nginx-admission
subjects:
- kind: ServiceAccount
  name: ingress-nginx-admission
  namespace: ingress-nginx
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  labels:
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
    app.kubernetes.io/version: 1.8.1
  name: ingress-nginx
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: ingress-nginx
subjects:
- kind: ServiceAccount
  name: ingress-nginx
  namespace: ingress-nginx
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  labels:
    app.kubernetes.io/component: admission-webhook
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
    app.kubernetes.io/version: 1.8.1
  name: ingress-nginx-admission
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: ingress-nginx-admission
subjects:
- kind: ServiceAccount
  name: ingress-nginx-admission
  namespace: ingress-nginx
---
# ============================================================================
# CONFIGMAP - NGINX Controller Configuration
# ============================================================================
# This ConfigMap contains configuration options for NGINX
# The controller reads this and generates the actual NGINX config file
# You can add options like:
#   proxy-body-size: "50m"  # Max request body size
#   proxy-connect-timeout: "10"  # Upstream connection timeout
#   use-gzip: "true"  # Enable gzip compression
#   ssl-protocols: "TLSv1.2 TLSv1.3"  # Allowed TLS versions
# ============================================================================
apiVersion: v1
data:
  allow-snippet-annotations: "true"  # Allow custom NGINX snippets in Ingress annotations (security risk in prod)
kind: ConfigMap
metadata:
  labels:
    app.kubernetes.io/component: controller
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
    app.kubernetes.io/version: 1.8.1
  name: ingress-nginx-controller  # Referenced by Deployment (--configmap flag)
  namespace: ingress-nginx
---
# ============================================================================
# SERVICE - Expose NGINX Controller
# ============================================================================
# This Service exposes the NGINX controller pods on ports 80 (HTTP) and 443 (HTTPS)
# Type: NodePort - For local/kind clusters, exposes on node ports
#       LoadBalancer - For cloud (EKS/GKE/AKS), creates cloud load balancer
# The kind-config.yaml maps these to localhost:80 and localhost:443
# ============================================================================
apiVersion: v1
kind: Service
metadata:
  labels:
    app.kubernetes.io/component: controller
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
    app.kubernetes.io/version: 1.8.1
  name: ingress-nginx-controller  # Service name (used by admission webhook)
  namespace: ingress-nginx
spec:
  ipFamilies:
  - IPv4  # Use IPv4 addresses
  ipFamilyPolicy: SingleStack  # IPv4 only (could be DualStack for IPv4+IPv6)
  ports:
  - appProtocol: http  # Application protocol (informational)
    name: http  # Port name
    port: 80  # External port (what clients connect to)
    protocol: TCP
    targetPort: http  # Target port on controller pod (named port from Deployment)
  - appProtocol: https
    name: https
    port: 443  # HTTPS port
    protocol: TCP
    targetPort: https  # Target port on controller pod
  selector:  # Route traffic to pods with these labels (from Deployment)
    app.kubernetes.io/component: controller
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
  type: NodePort  # For local: NodePort, For cloud: LoadBalancer
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app.kubernetes.io/component: controller
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
    app.kubernetes.io/version: 1.8.1
  name: ingress-nginx-controller-admission
  namespace: ingress-nginx
spec:
  ports:
  - appProtocol: https
    name: https-webhook
    port: 443
    targetPort: webhook
  selector:
    app.kubernetes.io/component: controller
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
  type: ClusterIP
---
# ============================================================================
# DEPLOYMENT - The actual NGINX Ingress Controller pods
# ============================================================================
# This is the heart of the ingress controller - the pods that run NGINX
# and watch for Ingress resources to configure routing
# ============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/component: controller
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
    app.kubernetes.io/version: 1.8.1
  name: ingress-nginx-controller  # Deployment name
  namespace: ingress-nginx
spec:
  minReadySeconds: 0  # Pod ready immediately after health checks pass
  revisionHistoryLimit: 10  # Keep 10 old ReplicaSets for rollback
  selector:
    matchLabels:  # Pods this Deployment manages
      app.kubernetes.io/component: controller
      app.kubernetes.io/instance: ingress-nginx
      app.kubernetes.io/name: ingress-nginx
  strategy:
    rollingUpdate:
      maxUnavailable: 1  # Max 1 pod down during updates
    type: RollingUpdate  # Update pods gradually
  template:
    metadata:
      labels:  # Labels applied to pods (must match selector above)
        app.kubernetes.io/component: controller
        app.kubernetes.io/instance: ingress-nginx
        app.kubernetes.io/name: ingress-nginx
        app.kubernetes.io/part-of: ingress-nginx
        app.kubernetes.io/version: 1.8.1
    spec:
      containers:
      - args:  # Command-line arguments for the controller
        - /nginx-ingress-controller  # Controller binary
        - --election-id=ingress-nginx-leader  # Leader election for HA
        - --controller-class=k8s.io/ingress-nginx  # Controller identifier
        - --ingress-class=nginx  # Watch for ingressClassName: nginx
        - --configmap=$(POD_NAMESPACE)/ingress-nginx-controller  # ConfigMap for NGINX config
        - --validating-webhook=:8443  # Admission webhook port
        - --validating-webhook-certificate=/usr/local/certificates/cert  # Webhook cert
        - --validating-webhook-key=/usr/local/certificates/key  # Webhook key
        - --watch-ingress-without-class=true  # Watch Ingress resources without ingressClassName
        - --publish-status-address=localhost  # Address to publish in Ingress status
        env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: LD_PRELOAD
          value: /usr/local/lib/libmimalloc.so
        image: registry.k8s.io/ingress-nginx/controller:v1.8.1@sha256:e5c4824e7375fcf2a393e1c03c293b69759af37a9ca6abdb91b13d78a93da8bd
        imagePullPolicy: IfNotPresent
        lifecycle:
          preStop:
            exec:
              command:
              - /wait-shutdown
        livenessProbe:
          failureThreshold: 5
          httpGet:
            path: /healthz
            port: 10254
            scheme: HTTP
          initialDelaySeconds: 10
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 1
        name: controller
        ports:
        - containerPort: 80
          hostPort: 80
          name: http
          protocol: TCP
        - containerPort: 443
          hostPort: 443
          name: https
          protocol: TCP
        - containerPort: 8443
          name: webhook
          protocol: TCP
        readinessProbe:
          failureThreshold: 3
          httpGet:
            path: /healthz
            port: 10254
            scheme: HTTP
          initialDelaySeconds: 10
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 1
        resources:
          requests:
            cpu: 100m
            memory: 90Mi
        securityContext:
          allowPrivilegeEscalation: true
          capabilities:
            add:
            - NET_BIND_SERVICE
            drop:
            - ALL
          runAsUser: 101
        volumeMounts:
        - mountPath: /usr/local/certificates/
          name: webhook-cert
          readOnly: true
      dnsPolicy: ClusterFirst
      nodeSelector:
        ingress-ready: "true"
        kubernetes.io/os: linux
      serviceAccountName: ingress-nginx
      terminationGracePeriodSeconds: 0
      tolerations:
      - effect: NoSchedule
        key: node-role.kubernetes.io/master
        operator: Equal
      - effect: NoSchedule
        key: node-role.kubernetes.io/control-plane
        operator: Equal
      volumes:
      - name: webhook-cert
        secret:
          secretName: ingress-nginx-admission
---
apiVersion: batch/v1
kind: Job
metadata:
  labels:
    app.kubernetes.io/component: admission-webhook
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
    app.kubernetes.io/version: 1.8.1
  name: ingress-nginx-admission-create
  namespace: ingress-nginx
spec:
  template:
    metadata:
      labels:
        app.kubernetes.io/component: admission-webhook
        app.kubernetes.io/instance: ingress-nginx
        app.kubernetes.io/name: ingress-nginx
        app.kubernetes.io/part-of: ingress-nginx
        app.kubernetes.io/version: 1.8.1
      name: ingress-nginx-admission-create
    spec:
      containers:
      - args:
        - create
        - --host=ingress-nginx-controller-admission,ingress-nginx-controller-admission.$(POD_NAMESPACE).svc
        - --namespace=$(POD_NAMESPACE)
        - --secret-name=ingress-nginx-admission
        env:
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        image: registry.k8s.io/ingress-nginx/kube-webhook-certgen:v20230407@sha256:543c40fd093964bc9ab509d3e791f9989963021f1e9e4c9c7b6700b02bfb227b
        imagePullPolicy: IfNotPresent
        name: create
        securityContext:
          allowPrivilegeEscalation: false
      nodeSelector:
        kubernetes.io/os: linux
      restartPolicy: OnFailure
      securityContext:
        fsGroup: 2000
        runAsNonRoot: true
        runAsUser: 2000
      serviceAccountName: ingress-nginx-admission
---
apiVersion: batch/v1
kind: Job
metadata:
  labels:
    app.kubernetes.io/component: admission-webhook
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
    app.kubernetes.io/version: 1.8.1
  name: ingress-nginx-admission-patch
  namespace: ingress-nginx
spec:
  template:
    metadata:
      labels:
        app.kubernetes.io/component: admission-webhook
        app.kubernetes.io/instance: ingress-nginx
        app.kubernetes.io/name: ingress-nginx
        app.kubernetes.io/part-of: ingress-nginx
        app.kubernetes.io/version: 1.8.1
      name: ingress-nginx-admission-patch
    spec:
      containers:
      - args:
        - patch
        - --webhook-name=ingress-nginx-admission
        - --namespace=$(POD_NAMESPACE)
        - --patch-mutating=false
        - --secret-name=ingress-nginx-admission
        - --patch-failure-policy=Fail
        env:
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        image: registry.k8s.io/ingress-nginx/kube-webhook-certgen:v20230407@sha256:543c40fd093964bc9ab509d3e791f9989963021f1e9e4c9c7b6700b02bfb227b
        imagePullPolicy: IfNotPresent
        name: patch
        securityContext:
          allowPrivilegeEscalation: false
      nodeSelector:
        kubernetes.io/os: linux
      restartPolicy: OnFailure
      securityContext:
        fsGroup: 2000
        runAsNonRoot: true
        runAsUser: 2000
      serviceAccountName: ingress-nginx-admission
---
# ============================================================================
# INGRESSCLASS - Critical: Links ingress.yaml to this controller
# ============================================================================
# This is THE KEY resource that connects everything together!
#
# When you create ingress.yaml with:
#   spec:
#     ingressClassName: nginx  ← References this IngressClass by name
#
# The NGINX controller looks for Ingress resources that reference this class
# and configures routing for them. Without this, your ingress.yaml won't work!
#
# Other ingress controllers (Traefik, ALB) would have their own IngressClass
# with different controller identifiers.
# ============================================================================
apiVersion: networking.k8s.io/v1
kind: IngressClass  # Defines an ingress controller class
metadata:
  labels:
    app.kubernetes.io/component: controller
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
    app.kubernetes.io/version: 1.8.1
  name: nginx  # ← This name is what ingress.yaml references with ingressClassName: nginx
spec:
  controller: k8s.io/ingress-nginx  # Controller identifier (matches --controller-class in Deployment)
---
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingWebhookConfiguration
metadata:
  labels:
    app.kubernetes.io/component: admission-webhook
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
    app.kubernetes.io/version: 1.8.1
  name: ingress-nginx-admission
webhooks:
- admissionReviewVersions:
  - v1
  clientConfig:
    service:
      name: ingress-nginx-controller-admission
      namespace: ingress-nginx
      path: /networking/v1/ingresses
  failurePolicy: Fail
  matchPolicy: Equivalent
  name: validate.nginx.ingress.kubernetes.io
  rules:
  - apiGroups:
    - networking.k8s.io
    apiVersions:
    - v1
    operations:
    - CREATE
    - UPDATE
    resources:
    - ingresses
  sideEffects: None
